__NUXT_JSONP__("/blog/post/clickhouse-local-aggregation", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N){return {data:[{post:{slug:"clickhouse-local-aggregation",description:"為了節省計算資源、簡化季度、年度資料處理流程，我們將從「使用 PostgresSQL 合併跨月資料」，改為「使用  ClickHouse local 合併跨月資料」。除了少數欄位名稱更改外，使用上並無其餘影響。\n對新合併法有興趣者，歡迎參見合併原始碼。",title:"消除重複住宅邏輯更新",author:"ddio",created:"2023-12-11T00:00:00.000Z",cover:"\u002Fimgs\u002Fblog\u002Fclickhouse-local.jpg",tags:["定期紀錄","封面圖片使用 AI 生成"],toc:[{id:y,depth:r,text:z},{id:s,depth:r,text:s},{id:t,depth:r,text:t},{id:u,depth:r,text:u},{id:A,depth:3,text:B}],body:{type:C,children:[{type:b,tag:e,props:{},children:[{type:a,value:D},{type:b,tag:f,props:{href:E,rel:[i,j,k],target:l},children:[{type:a,value:F}]},{type:a,value:G}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:H},{type:b,tag:f,props:{href:w,rel:[i,j,k],target:l},children:[{type:a,value:I}]},{type:a,value:x}]},{type:a,value:c},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"以下將以「原合併法」代稱「使用 PostgresSQL 合併跨月資料」，「新合併法」代稱「使用 clickhouse-local 合併跨月資料」。"}]},{type:a,value:c},{type:b,tag:v,props:{id:y},children:[{type:b,tag:f,props:{href:"#%E8%AA%BF%E6%95%B4%E7%9A%84%E6%AC%84%E4%BD%8D%E5%8F%AA%E5%BD%B1%E9%9F%BF%E6%B6%88%E9%99%A4%E9%87%8D%E8%A4%87%E4%BD%8F%E5%AE%85",ariaHidden:m,tabIndex:n},children:[{type:b,tag:o,props:{className:[p,q]},children:[]}]},{type:a,value:z}]},{type:a,value:c},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"「最大刊登者編碼」改為「常見刊登者編碼」"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"「約略地點範圍」改為兩個欄位：「常見約略地點_x」、「常見約略地點_y」"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"新增「物件最後更新時間」"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:v,props:{id:s},children:[{type:b,tag:f,props:{href:"#%E5%85%A9%E7%A8%AE%E5%90%88%E4%BD%B5%E6%B3%95%E7%9A%84%E8%B3%87%E6%96%99%E8%A7%A3%E9%87%8B%E5%B7%AE%E7%95%B0",ariaHidden:m,tabIndex:n},children:[{type:b,tag:o,props:{className:[p,q]},children:[]}]},{type:a,value:s}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"新合併法的主要特性為："}]},{type:a,value:c},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"傾向使用「最常出現的數值」，而非「最新出現的數值」"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"因為上述原因，在「消除重複住宅資料集」中，合併的標的將由原本的「各住宅的各欄位的最新的數值」，改為「各住宅各欄位最常出現的數值」"}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"在新合併法中，針對時間類型以外的欄位，我們使用 "},{type:b,tag:h,props:{},children:[{type:a,value:J}]},{type:a,value:" 當作合併的方法，而非原本的 "},{type:b,tag:h,props:{},children:[{type:a,value:"last"}]},{type:a,value:" ，也就是說，資料集會呈現此同一個物件中「最常出現」，而非「最後一個月份出現」的數值。以「常見刊登者編碼」為例，假設某個物件在 2021 年 1 月、2 月、3 月都出現過，且刊登者編碼分別為 A、A、B，那麼在新合併法中，此物件的「常見刊登者編碼」為 A，而非原合併法中的 B。"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"在「消除重複住宅資料集」中，新原合併法的流程方別為："}]},{type:a,value:c},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"原合併法：\n"},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"針對「儲存各物件最新數值的資料表」，以"},{type:b,tag:K,props:{to:L},children:[{type:a,value:M}]}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"新合併法：\n"},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"下載對應的各月份資料集"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"以物件編號為索引，合併為單一資料集，合併時留用最常出現的數值"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"針對合併後的單一資料集，以"},{type:b,tag:K,props:{to:L},children:[{type:a,value:M}]}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"由於新合併法流程上的設計，自 2023 起的季度、年度「消除重複住宅資料集」，將會使用「以月為單位，最常出現的數值」為物件最後的數值。"}]},{type:a,value:c},{type:b,tag:v,props:{id:t},children:[{type:b,tag:f,props:{href:"#%E6%96%B0%E5%90%88%E4%BD%B5%E6%B3%95%E7%9A%84%E5%84%AA%E9%BB%9E",ariaHidden:m,tabIndex:n},children:[{type:b,tag:o,props:{className:[p,q]},children:[]}]},{type:a,value:t}]},{type:a,value:c},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"執行速度、費用均顯著減少\n"},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"由於原仰賴 PostgresSQL，需要較多設定、記憶體，才能執行幾十萬筆資料的合併，以季度資料為例，至少需要 16GB 記憶體，執行至少 4 小時。"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"新合併法無須架設伺服器，僅需以個人電腦執行，大約 30 秒即可完成季度資料的整併。"}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"修正就合併法的問題\n"},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"在檢查新合併法的資料正確性時發現，由於原合併法使用 Django ORM 撰寫 SQL ，因此在特定情況下，沒有將「不同月份，標為不同出租狀態的同物件」合併的情況，新合併法則正確合併這類物件。"}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c},{type:b,tag:v,props:{id:u},children:[{type:b,tag:f,props:{href:"#%E6%AD%A1%E8%BF%8E%E8%87%AA%E8%A1%8C%E8%AA%BF%E6%95%B4%E5%90%88%E4%BD%B5%E9%82%8F%E8%BC%AF",ariaHidden:m,tabIndex:n},children:[{type:b,tag:o,props:{className:[p,q]},children:[]}]},{type:a,value:u}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"由於新合併法的執行成本、環境需求均遠低於原合併法，因此也更適合由資料分析者自行調整合併的邏輯，以符合各自的需求。"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"若有需要自行調整合併邏輯的需求，可參考"},{type:b,tag:f,props:{href:w,rel:[i,j,k],target:l},children:[{type:a,value:"資料合併小幫手原始碼"}]},{type:a,value:x}]},{type:a,value:c},{type:b,tag:"h3",props:{id:A},children:[{type:b,tag:f,props:{href:"#clickhouse-local-%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%A7%98%E8%A8%A3",ariaHidden:m,tabIndex:n},children:[{type:b,tag:o,props:{className:[p,q]},children:[]}]},{type:a,value:B}]},{type:a,value:c},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"由於這裡的 CSV 資料集，都是用 "},{type:b,tag:h,props:{},children:[{type:a,value:"-"}]},{type:a,value:" 作為空白欄位的標記，因此下 SQL 時，記得在開頭加上 "},{type:b,tag:h,props:{},children:[{type:a,value:"SET format_csv_null_representation = '-';"}]},{type:a,value:" ，讓 ClickHouse 自行轉換空白值，讓欄位資料型態判斷更準確。"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"除了 "},{type:b,tag:h,props:{},children:[{type:a,value:J}]},{type:a,value:" 外，ClickHouse 也有提供不少 aggregation 函式，例如 "},{type:b,tag:h,props:{},children:[{type:a,value:"topK"}]},{type:a,value:" "},{type:b,tag:h,props:{},children:[{type:a,value:"groupArray"}]},{type:a,value:" ，可以顯示合併前的多筆數值，更多用法可參考 "},{type:b,tag:f,props:{href:"https:\u002F\u002Fclickhouse.com\u002Fdocs\u002Fen\u002Fsql-reference\u002Faggregate-functions",rel:[i,j,k],target:l},children:[{type:a,value:"Aggregate Functions"}]},{type:a,value:"。\n"},{type:b,tag:g,props:{},children:[{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"要注意的是，由於使用 ClickHouse 時， 無法指定各 CSV 檔的匯入順序，因此使用 "},{type:b,tag:h,props:{},children:[{type:a,value:"last_value"}]},{type:a,value:" 時，並無法保證一定是最後一個月的資料。"}]},{type:a,value:c}]},{type:a,value:c}]},{type:a,value:c}]}]},excerpt:{type:C,children:[{type:b,tag:e,props:{},children:[{type:a,value:D},{type:b,tag:f,props:{href:E,rel:[i,j,k],target:l},children:[{type:a,value:F}]},{type:a,value:G}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:H},{type:b,tag:f,props:{href:w,rel:[i,j,k],target:l},children:[{type:a,value:I}]},{type:a,value:x}]}]},dir:"\u002Fblog",path:"\u002Fblog\u002Fclickhouse-local-aggregation",extension:".md",createdAt:N,updatedAt:N}}],fetch:{},mutations:void 0}}("text","element","\n","li","p","a","ol","code","nofollow","noopener","noreferrer","_blank","true",-1,"span","icon","icon-link",2,"兩種合併法的資料解釋差異","新合併法的優點","歡迎自行調整合併邏輯","h2","https:\u002F\u002Fgithub.com\u002Fg0v\u002Ftw-rental-house-data\u002Ftree\u002Fmaster\u002Fcsv-aggregator","。","調整的欄位只影響消除重複住宅","調整的欄位（只影響消除重複住宅）：","clickhouse-local-使用小秘訣","ClickHouse local 使用小秘訣","root","為了節省計算資源、簡化季度、年度資料處理流程，我們將從「使用 PostgresSQL 合併跨月資料」，改為「使用  ","https:\u002F\u002Fclickhouse.com\u002Fdocs\u002Fen\u002Foperations\u002Futilities\u002Fclickhouse-local","ClickHouse local"," 合併跨月資料」。除了少數欄位名稱更改外，使用上並無其餘影響。","對新合併法有興趣者，歡迎參見","合併原始碼","anyHeavy","nuxt-link","\u002Fabout-data-set\u002F0.2","表訂的共同欄位合併","2024-03-10T07:31:52.663Z")));